<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.board.mapper.UserMapper">

	<sql id="userColumns">
		id
		, pw
		, pwHint
		, email
		, userType
		, nickname
		, age
		, gender
		, managerYn
		, regDate
	</sql>

	<sql id="surveyOutputColumns">
		idx
		, ID
		, TestDate
		, UserAnswer
		, UserType
	</sql>

	<insert id="insertUser" parameterType="UserDTO">
		INSERT INTO member (
		<include refid="userColumns" />
		) VALUES (
		#{id}
		, #{pw}
		, #{pwHint}
		, #{email}
		, null
		, CONCAT(#{id}, '_',
		#{userType})
		, #{age}
		, #{gender}
		, 0
		, NOW()
		)
	</insert>

	<select id="selectUserDetail" parameterType="String"
		resultType="UserDTO">
		SELECT
		<include refid="userColumns" />
		FROM
		member
		WHERE
		id = #{id}
	</select>

	<update id="updateUser" parameterType="UserDTO">
		UPDATE Member
		SET
		pw =
		IFNULL(#{pw}, pw)
		, pwHint = IFNULL(#{pwHint}, pwHint)
		, userType =
		(select userType
		from Mbti_ML_Output
		where TestDate = (select
		MAX(TestDate)
		from Mbti_ML_Output
		where id = #{id}))
		, nickname =
		CONCAT(id, '_', userType)
		WHERE
		id = #{id}
	</update>

	<delete id="deleteUser" parameterType="String">
		DELETE FROM member
		WHERE
		id
		= #{id}
	</delete>

	<select id="selectUserHistory" parameterType="String"
		resultType="SurveyOutputDTO">
		select
		<include refid="surveyOutputColumns" />
		from Mbti_ML_Output
		where ID = #{id}
		order by TestDate
	</select>

	<select id="selectUserHistoryCount" parameterType="String"
		resultType="int">
		SELECT
		COUNT(b.userType)
		from Member a, Mbti_ML_Output b
		where a.ID = b.ID
		and a.ID = #{id}
		order by b.TestDate
	</select>

	<select id= "findId" resultType="UserDTO">
		select 
		<include refid="userColumns" />
		from Member
		where Email=#{email} 
	</select>

	<select id= "findPw" resultType="UserDTO">
		select 
		<include refid="userColumns" />
		from Member
		where PwHint=#{pwHint} 
	</select>
	
</mapper>